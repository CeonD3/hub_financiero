<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Open Pay</title>
		<link data-n-head="1" rel="icon" type="image/x-icon" href="https://www.openpay.pe/favicon.png">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
		<link rel="stylesheet" href="/assets/openpay/styles.css">
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <script type="text/javascript" src="https://js.openpay.pe/openpay.v1.min.js"></script>
        <script type='text/javascript' src="https://js.openpay.pe/openpay-data.v1.min.js"></script>
		<style>
			body {
				background-image: url('https://www.openpay.pe/_nuxt/img/desktop-campana.7556213.png');
				background-position: center;
				background-size: cover;
				background-repeat: no-repeat;
				background-color: #004481
			}
		</style>
	</head>
	<body>
		<nav class="navbar navbar-light bg-white shadow">
			<div class="container py-2">
				<a class="navbar-brand" href="#"><img src="https://www.openpay.pe/_nuxt/img/openpay-color.77b290c.png" height="50"></a>
			</div>
		</nav>
		<div class="container mt-5">
			{# <div class="d-flex justify-content-center"> #}
			<div>
				<div class="col-lg-8 my-4">
					{% if success %}
					<div class="card rounded">
						<div class="card-body p-4">
							<div class="row">
								<div class="col-lg-12">
									<p class='main-description'>
										<span>Vas a pagar el importe de S/  {{ data.amount }}.</span>
										Selecciona el método de pago que quieras usar:
									</p>
								</div>
							</div>
							<form action="/api/openpay/transaction/{{data.paymentId}}" method="POST" id="payment-form">
								<input type="hidden" name="tokenId" id="tokenId">
								<input type="hidden" name="deviceSessionId" id="deviceSessionId">
								<div class='payment-methods' id='payment-methods' style="display: none;">
									<div class='payment-methods__method payment-methods__method--selected' id='payment-card' data-method='method-card'>
										<img src="/assets/openpay/images/tarjeta.svg" alt="tarjeta">
										<span>Tarjeta de crédito o débito</span>
									</div>
									<div class='payment-methods__method' id='payment-digital' data-method='method-digital'>
										<img src="/assets/openpay/images/digital.svg" alt="digital">
										<span>Pago digital a través de la App o Web de tu banco</span>
									</div>
									<div class='payment-methods__method' id='payment-agent' data-method='method-agent'>
										<img src="/assets/openpay/images/agentes.svg" alt="agentes">
										<span>Pago presencial en agentes, agencias o establecimientos afiliados</span>
									</div>
								</div>
								<div class='method-card' id='method-card'>
									<div class="row">
										<div class="col-lg-12">
											<div class='method-card__images'>
												<img src="/assets/openpay/images/visa.svg" alt="visa">
												<img src="/assets/openpay/images/mastercard.svg" alt="mastercard">
												<img src="/assets/openpay/images/american-express.svg" alt="american-express">
												<img src="/assets/openpay/images/diners.svg" alt="diners">
											</div>
										</div>
										<div class="col-lg-12">
											<p class='method-card__description'>
												Recuerda que algunas tarjetas cuentan con el código de seguridad o CVV Dinámico,
														consúltalo desde el App de tu banco.
											</p>
											<div id="alert-payment"></div>
										</div>
									</div>
									<div class="row">
										<div class="col-lg-6 mb-3">
											<input class="form-control shadow-none" type="text" placeholder='Nombre del Titular' data-openpay-card="holder_name" size="50">
										</div>
										<div class="col-lg-6 mb-3">
											<input class="form-control shadow-none" type="text" placeholder='Número de la Tarjeta' data-openpay-card="card_number" size="50">
										</div>
										<div class="col-lg-6 mb-3">
											<div class="input-group mb-3">
												<input class="form-control shadow-none" placeholder="MM" data-openpay-card="expiration_month" size="4" type="text">
												<span class="input-group-text">/</span>
												<input class="form-control shadow-none" placeholder="AA" data-openpay-card="expiration_year" size="4" type="text">
											</div>
										</div>
										<div class="col-lg-6 mb-3">
											<input class="form-control shadow-none" type="text" placeholder="CCV" data-openpay-card="cvv2" size="5">
										</div>
									</div>
									<div class="row">
										<div class="col-lg-12 mt-4 text-end">
											<a href="{{ data.timeoutUrl }}" class="btn btn-danger px-5 me-2">
												Cancelar
											</a>
											<button class="btn btn-dark px-5" id="pay-button">
												Pagar
											</button>
										</div>
									</div>
								</div>
							</form>
							<div class='method-digital' id='method-digital' style='display: none;'>
								<div class='method-digital__images'>
									<img src="/assets/openpay/images/openpay.svg" alt="bbva">
									<img src="/assets/openpay/images/bcp.svg" alt="bcp">
									<img src="/assets/openpay/images/interbank.svg" alt="interbank">
									<img src="/assets/openpay/images/scotiabank.svg" alt="scotiabank">
								</div>
								<p class='method-digital__description'>
									En la App o Web de tu banco ingresa a la opción
									<span>"Pago de Servicios"</span>,
												busca
									<span>"Kashio"</span>, coloca el código de pago que llegará a tu correo
												electrónico y realiza el pago.
								</p>
								<button class='method-digital__button'>
									Genera tu código
								</button>
							</div>
							<div class='method-digital' id='method-agent' style='display: none;'>
								<div class='method-digital__images'>
									<img src="/assets/openpay/images/openpay.svg" alt="bbva">
									<img src="/assets/openpay/images/bcp.svg" alt="bcp">
									<img src="/assets/openpay/images/interbank.svg" alt="interbank">
									<img src="/assets/openpay/images/scotiabank.svg" alt="scotiabank">
									<img src="/assets/openpay/images/tambo.svg" alt="tambo">
									<img src="/assets/openpay/images/kasnet.svg" alt="kasnet">
								</div>
								<p class='method-digital__description'>
									Paga en agentes, agencias o establecimientos afiliados con el código de
											referencia que llegará a tu correo electrónico, indicando que deseas
											pagar
									<span>"Kashio"</span>.
								</p>
								<form action="/api/openpay/store/{{data.paymentId}}" method="POST" id="agent-form">
								</form>
								<button class='method-digital__button' form="agent-form" type="submit">
									Genera tu código
								</button>
							</div>
						</div>
					</div>
					{% else %}
					<div class="container-fluid">
						<div class="alert alert-danger" role="alert">
							<strong>Error: </strong> {{ message }}
						</div>				
					</div>
					{% endif %}
				</div>
			</div>
		</div>
		<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.min.js" integrity="sha384-7VPbUDkoPSGFnVtYi0QogXtr74QeVeeIs99Qfg5YCF+TidwNdjvaKZX19NZ/e6oz" crossorigin="anonymous"></script>
		<script src="/assets/openpay/main.js"></script>
        <script type="text/javascript">
            $(document).ready(function() {
				const paymentId = "{{data.paymentId}}";
                OpenPay.setId("{{ data.merchantId }}");
                OpenPay.setApiKey("{{ data.publicKey }}");
				OpenPay.setSandboxMode(true);
				const purchaseNumber = "{{ data.purchaseNumber }}";
                var deviceSessionId = OpenPay.deviceData.setup("payment-form", purchaseNumber);
				$('#deviceSessionId').val(deviceSessionId); 

				var messageHTML = function (title, message) {
					return `
						<div class="alert alert-warning alert-dismissible fade show" role="alert">
							<strong>${title}: </strong> ${message}
							<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
						</div>`;
				}

				var success_callbak = function(response) {
					var token_id = response.data.id; 
					$('#tokenId').val(token_id); 
					$('#payment-form').submit();
				}

				var error_callbak = function(response) {
					var desc = response.data.description != undefined ? response.data.description : response.message; 
					// alert("ERROR [" + response.status + "] " + desc); 
					document.getElementById("alert-payment").innerHTML = `
					<div class="alert alert-danger alert-dismissible fade show" role="alert">
						<strong>ERROR: ${response.status}!</strong> ${desc}.
						<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
					</div>`;
					$("#pay-button").prop("disabled", false); 
				};

				$('#pay-button').on('click', function(event) {
					event.preventDefault(); 
					$("#pay-button").prop( "disabled", true); 
					OpenPay.token.extractFormAndCreate('payment-form', success_callbak, error_callbak); 
				});

				$('#method-agent-button').on('click', function(event) {
					event.preventDefault(); 
					const formData = new FormData();
					fetch('/api/openpay/store/'+paymentId, {
						method: 'POST'
					})
					.then(response => response.json())
					.then(data => {
						console.log(data)
					})
					.catch(error=>console.log(error));
				});

            });
        </script>
	</body>
</html>
